{
  "content": {
    "title": "Store Drupal logs on Amazon S3",
    "created": "24 Jun, 2019",
    "author": "Karthik Kumar D K",
    "views": "463",
    "summary": "Store Drupal logs on Amazon S3 via hook_watchdog, so that you can get rid of heavy logs on your drupal database and can later read from the S3",
    "content": "<p>Store Drupal logs on Amazon S3 via hook_watchdog, so that you can get rid of heavy logs on your drupal database and can later read from the S3.</p>\n                                <p>For this todo on Drupal</p>\n                                <ul>\n                                    <li>You should use the \"hook_watchdog\" hook, where this hook allows modules to route log events to custom destinations.</li>\n                                    <li>In our case, our custom destination will be S3.</li>\n                                    <li>Initially we need to get the access to AWS and appropriate S3 bucket.</li>\n                                    <li>Store the connection configuration details of S3 buckets in the Drupal.</li>\n                                    <li>In the hook_watchdog, read the S3 Auth configs.</li>\n                                    <li>Create a connection to AWS S3, on success it return back with the S3 object.</li>\n                                    <li>Check if any buckets exist to write the logs, of not you should create bucket on S3 for logs.</li>\n                                    <li>Next, Create a log directory and log file, populate it with the data came on hook_watchdog.</li>\n                                    <li>Next, Write to the S3 bucket with parameters which \"putObject\" expects.</li>\n                                    <li>Next, Remove the log directory &amp; file which is created in the process.</li>\n                                    <li>Check the S3 bucket via S3 UI, you could see the logs</li>\n                                </ul>\n                                <p>Here's the piece of code, via we log to S3.</p>\n                                <pre style=\"background-color:#ffffff;color:#000000;font-family:'DejaVu Sans Mono';font-size:9.0pt;\"><span style=\"background-color:#f7faff;\">watchdog(\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'module_2'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">    t(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Info: Successfully completed.'</span><span style=\"background-color:#f7faff;\">),\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">array</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$data</span><span style=\"background-color:#f7faff;\">),\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;font-style:italic;\">WATCHDOG_INFO\n</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">watchdog(\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'module_3'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">    t(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Error: Issue while processing.'</span><span style=\"background-color:#f7faff;\">),\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">array</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$exception, $data</span><span style=\"background-color:#f7faff;\">),\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;font-style:italic;\">WATCHDOG_ERROR\n</span><span style=\"background-color:#f7faff;\">);</span></pre><p>Here, the piece of code which helps to connect &amp; write log's to S3.</p>\n                                <pre style=\"background-color:#ffffff;color:#000000;font-family:'DejaVu Sans Mono';font-size:9.0pt;\"><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">&lt;?php\n\nuse </span><span style=\"background-color:#f7faff;\">\\Aws\\S3\\S3Client;\n</span>\n</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">audit_watchdog(</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">array </span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Set the modules which needs to be logged to S3\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$modules </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">array</span><span style=\"background-color:#f7faff;\">(\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'module_1'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'module_2'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'module_3'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">    );\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"background-color:#f7faff;font-style:italic;\">in_array</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">[</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'type'</span><span style=\"background-color:#f7faff;\">], </span><span style=\"color:#660000;background-color:#f7faff;\">$modules</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">isset</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">) &amp;&amp; !</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Get the S3 config details\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_config </span><span style=\"background-color:#f7faff;\">= variable_get(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"s3_config\"</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_bucket </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_config</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;\">s3_bucket</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_region </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_config</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;\">s3_region</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_key </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_config</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;\">s3_key</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_secret </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_config</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#660e7a;background-color:#f7faff;font-weight:bold;\">s3_secret</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">try </span><span style=\"background-color:#f7faff;\">{\n</span><span style=\"background-color:#f7faff;\">                </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(!</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_bucket</span><span style=\"background-color:#f7faff;\">) &amp;&amp; !</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_region</span><span style=\"background-color:#f7faff;\">) &amp;&amp; !</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_key</span><span style=\"background-color:#f7faff;\">) &amp;&amp; !</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_secret</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">                    </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Create AWS connection\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                    </span><span style=\"color:#660000;background-color:#f7faff;\">$s3 </span><span style=\"background-color:#f7faff;\">= create_aws_connection(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_region</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_key</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_secret</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(!</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">) &amp;&amp; </span><span style=\"background-color:#f7faff;font-style:italic;\">is_object</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">) &amp;&amp; </span><span style=\"color:#660000;background-color:#f7faff;\">$s3 </span><span style=\"background-color:#f7faff;\">!= </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">FALSE</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">                        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">-&gt;doesBucketExist(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_bucket</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#660000;background-color:#f7faff;\">$log_path </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'public://logs/to_aws'</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Create log directory\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                            </span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path </span><span style=\"background-color:#f7faff;\">= create_aws_log_directory(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Create log file\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                            </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path </span><span style=\"background-color:#f7faff;\">= create_aws_log_file(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Get the name of log file\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                            </span><span style=\"color:#660000;background-color:#f7faff;\">$keyname </span><span style=\"background-color:#f7faff;\">= get_keyname_for_log_file(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">[</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'severity'</span><span style=\"background-color:#f7faff;\">], </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Store the log file to S3\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                            </span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">putObject</span><span style=\"background-color:#f7faff;\">([\n</span><span style=\"background-color:#f7faff;\">                                </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Bucket' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_bucket</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">                                </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Key' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$keyname</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">                                </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Body' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">''</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">                                </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'SourceFile' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">                            ]);\n</span><span style=\"background-color:#f7faff;\">                            </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Remove the directory &amp; file created\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                            </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"background-color:#f7faff;font-style:italic;\">is_dir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">                                rmdir_recursive(</span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                                rmdir_recursive(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'public://logs'</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">                            }\n</span><span style=\"background-color:#f7faff;\">                        }\n</span><span style=\"background-color:#f7faff;\">                    }\n</span><span style=\"background-color:#f7faff;\">                }\n</span><span style=\"background-color:#f7faff;\">            }\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">catch </span><span style=\"background-color:#f7faff;\">(Exception </span><span style=\"color:#660000;background-color:#f7faff;\">$e</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">                </span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">// Exception is ignored so that watchdog does not break pages during the\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                // installation process or is not able to create the watchdog table during\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">                // installation.\n</span><span style=\"color:#808080;background-color:#f7faff;font-style:italic;\">            </span><span style=\"background-color:#f7faff;\">}\n</span><span style=\"background-color:#f7faff;\">        }\n</span><span style=\"background-color:#f7faff;\">    }\n</span><span style=\"background-color:#f7faff;\">}\n</span>\n<span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">create_aws_connection(</span><span style=\"color:#660000;background-color:#f7faff;\">$s3_region</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_key</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_secret</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$s3 </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">new </span><span style=\"background-color:#f7faff;\">S3Client([\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'version' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'latest'</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'region'  </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_region</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'credentials' </span><span style=\"background-color:#f7faff;\">=&gt; [\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'key'    </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_key</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">            </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'secret' </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#660000;background-color:#f7faff;\">$s3_secret</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        ]\n</span><span style=\"background-color:#f7faff;\">    ]);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$buckets </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">-&gt;</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">listBuckets</span><span style=\"background-color:#f7faff;\">()-&gt;get(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'Buckets'</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">isset</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$buckets</span><span style=\"background-color:#f7faff;\">) &amp;&amp; !</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">empty</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$buckets</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">return </span><span style=\"color:#660000;background-color:#f7faff;\">$s3</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">    }\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">else </span><span style=\"background-color:#f7faff;\">{\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">return FALSE</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">    }\n</span><span style=\"background-color:#f7faff;\">}\n</span>\n<span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">create_aws_log_directory(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(!</span><span style=\"background-color:#f7faff;font-style:italic;\">is_dir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">)) {\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"background-color:#f7faff;font-style:italic;\">mkdir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#0000ff;background-color:#f7faff;\">0777</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">true</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"background-color:#f7faff;font-style:italic;\">chmod</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#0000ff;background-color:#f7faff;\">0777</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    }\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">return </span><span style=\"color:#660000;background-color:#f7faff;\">$log_path</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">}\n</span>\n<span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">create_aws_log_file(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$content </span><span style=\"background-color:#f7faff;\">= </span><span style=\"background-color:#f7faff;font-style:italic;\">json_encode</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$log_file_name </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$log_entry</span><span style=\"background-color:#f7faff;\">[</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'type'</span><span style=\"background-color:#f7faff;\">] . </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'-' </span><span style=\"background-color:#f7faff;\">. </span><span style=\"background-color:#f7faff;font-style:italic;\">date</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"Y-m-d-H-i-s\"</span><span style=\"background-color:#f7faff;\">) . </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'-' </span><span style=\"background-color:#f7faff;\">. </span><span style=\"background-color:#f7faff;font-style:italic;\">preg_replace</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"/^.*\\./i\"</span><span style=\"background-color:#f7faff;\">,</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"\"</span><span style=\"background-color:#f7faff;\">, </span><span style=\"background-color:#f7faff;font-style:italic;\">microtime</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">true</span><span style=\"background-color:#f7faff;\">)) . </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'.log'</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#660000;background-color:#f7faff;\">$dir_path </span><span style=\"background-color:#f7faff;\">. </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'/' </span><span style=\"background-color:#f7faff;\">. </span><span style=\"color:#660000;background-color:#f7faff;\">$log_file_name</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$log_file </span><span style=\"background-color:#f7faff;\">= </span><span style=\"background-color:#f7faff;font-style:italic;\">fopen</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"w\"</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$write_log_file </span><span style=\"background-color:#f7faff;\">= </span><span style=\"background-color:#f7faff;font-style:italic;\">fwrite</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_file</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$content</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$close_log_file </span><span style=\"background-color:#f7faff;\">= </span><span style=\"background-color:#f7faff;font-style:italic;\">fclose</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$log_file</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$chmod_log_file </span><span style=\"background-color:#f7faff;\">= </span><span style=\"background-color:#f7faff;font-style:italic;\">chmod</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#0000ff;background-color:#f7faff;\">0777</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">return </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">}\n</span>\n<span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">get_keyname_for_log_file(</span><span style=\"color:#660000;background-color:#f7faff;\">$severity</span><span style=\"background-color:#f7faff;\">, </span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#660000;background-color:#f7faff;\">$watchdog_array </span><span style=\"background-color:#f7faff;\">= </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">array</span><span style=\"background-color:#f7faff;\">(\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"0\" </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"WATCHDOG_ERROR\"</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"1\" </span><span style=\"background-color:#f7faff;\">=&gt; </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"WATCHDOG_INFO\"</span><span style=\"background-color:#f7faff;\">,\n</span><span style=\"background-color:#f7faff;\">    );\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">return </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'drupal-logs/' </span><span style=\"background-color:#f7faff;\">. </span><span style=\"color:#660000;background-color:#f7faff;\">$watchdog_array</span><span style=\"background-color:#f7faff;\">[</span><span style=\"color:#660000;background-color:#f7faff;\">$severity</span><span style=\"background-color:#f7faff;\">] . </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'/' </span><span style=\"background-color:#f7faff;\">. </span><span style=\"background-color:#f7faff;font-style:italic;\">basename</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$file_path</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">}\n</span>\n<span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">function </span><span style=\"background-color:#f7faff;\">rmdir_recursive(</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">foreach</span><span style=\"background-color:#f7faff;\">(</span><span style=\"background-color:#f7faff;font-style:italic;\">scandir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"background-color:#f7faff;\">) </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">as </span><span style=\"color:#660000;background-color:#f7faff;\">$file</span><span style=\"background-color:#f7faff;\">) {\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'.' </span><span style=\"background-color:#f7faff;\">=== </span><span style=\"color:#660000;background-color:#f7faff;\">$file </span><span style=\"background-color:#f7faff;\">|| </span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">'..' </span><span style=\"background-color:#f7faff;\">=== </span><span style=\"color:#660000;background-color:#f7faff;\">$file</span><span style=\"background-color:#f7faff;\">) </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">continue</span><span style=\"background-color:#f7faff;\">;\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">if </span><span style=\"background-color:#f7faff;\">(</span><span style=\"background-color:#f7faff;font-style:italic;\">is_dir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">/</span><span style=\"color:#660000;background-color:#f7faff;\">$file</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"background-color:#f7faff;\">)) rmdir_recursive(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">/</span><span style=\"color:#660000;background-color:#f7faff;\">$file</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">        </span><span style=\"color:#000080;background-color:#f7faff;font-weight:bold;\">else </span><span style=\"background-color:#f7faff;font-style:italic;\">unlink</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">/</span><span style=\"color:#660000;background-color:#f7faff;\">$file</span><span style=\"color:#008000;background-color:#f7faff;font-weight:bold;\">\"</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">    }\n</span><span style=\"background-color:#f7faff;\">    </span><span style=\"background-color:#f7faff;font-style:italic;\">rmdir</span><span style=\"background-color:#f7faff;\">(</span><span style=\"color:#660000;background-color:#f7faff;\">$dir</span><span style=\"background-color:#f7faff;\">);\n</span><span style=\"background-color:#f7faff;\">}\n</span></pre><p><span style=\"background-color:#f7faff;\">Advantage of having Logs on S3</span></p>\n                                <ul>\n                                    <li><span style=\"background-color:#f7faff;\">Reduce the number of DB log entries on Drupal database.</span></li>\n                                    <li><span style=\"background-color:#f7faff;\">Completely Keep the Audit system outside Drupal, So Prod instance will play smooth.</span></li>\n                                </ul>\n                                <p><span style=\"background-color:#f7faff;\">Cheers :)</span></p>",
    "type": "Sci-Tech",
    "category": "Drupal",
    "banner394x449": "upload/banner394x449/public/amazons3_drupal.png",
    "banner600x500": "upload/banner600x500/public/amazons3_drupal.png",
    "banner788x443": "upload/banner788x443/public/amazons3_drupal.png",
    "banner800x460": "upload/banner800x460/public/amazons3_drupal.png",
    "file": "2019-06-24-store-drupal-logs-amazon-s3.json"
  }
}